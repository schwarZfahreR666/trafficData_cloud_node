{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>冬奥会数据感知采集与融合处理系统</title>
    <link rel="stylesheet" href="{% static 'css/home_.css' %}">
    <link rel="stylesheet" href="{% static 'css/jDialog.css' %}">
</head>
<body style="font-size: 16px;">
    <!-- 左边栏 -->
    <div class="leftbox">
        {% include 'sidenav.html' %}
    </div>
    <!-- 主容器 -->
    <div class="container">
        <!-- 上面头部 -->
        <header>
            <h1>北京冬奥会态势感知数据采集及融合系统-延庆赛区</h1>

        </header>
        <!-- 下面主体 -->
        <section class="mainbox">
            <!-- 分两列 -->
            <div class="column1">
                <!-- 主体图 -->
                <div class="map">
                    <div class="map1" id="map1">

                    </div>
                    <div class="anchor">

                    </div>
                </div>
            </div>
            <div class="column2">
                <div class="weather">
                    <!-- 天气图表 -->
                    <div id="weather-v2-plugin-standard"></div>
                </div>
                <div class="navbar">
                    {% include 'home_navbar.html' %}

                </div>
                <div class="slider">
                <div class="slideTxtBox">
                    <div class="hd">
                        <ul><li>事件信息</li><li>赛事信息</li></ul>
                    </div>


                    <div class="bd" id="bd_slide">
                    <div class="txtMarquee-top1">
                        <ul class="infoList1" id="p1" >

                        </ul>
                    </div>

                    <div class="txtMarquee-top2">
                        <ul class="infoList2" id="p2">

                        </ul>
                    </div>

                </div>
                </div>

            </div>
        </div>
        </section>
    </div>



    <!-- script部分 -->
    <script src="{% static 'js/flexible.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery-2.1.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.SuperSlide.2.1.1.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.easyui.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.drag.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.mask.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.dialog.js' %}"></script>





    <script type="text/javascript">
        $(".txtMarquee-top1").slide({mainCell:".infoList1",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});
        $(".txtMarquee-top2").slide({mainCell:".infoList2",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});
        {#$(".txtMarquee-top3").slide({mainCell:".infoList3",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});#}
        {#jQuery(".txtMarquee-top4").slide({mainCell:".infoList3",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});#}
        $(".slideTxtBox").slide({ effect:"left" ,autoPlay:true, interTime:10000});
    </script>

<script>
    WIDGET = {
      CONFIG: {
        "layout": 2,
        "width": "270",
        "height": "270",
        "background": 1,
        "dataColor": "FFFFFF",
        "borderRadius": 5,
        "city": "CN101010800",
        "key": "H1kQFiLkmC"
      }
    }
    </script>
    <script src="https://apip.weatherdt.com/standard/static/js/weather-standard-common.js?v=2.0"></script>


    <script>
    //假设每隔5秒发送一次请求
    window.onload = function () {

        loadSVGInline();
        getApi();
        setTimeout('myrefresh()',700*1000);


    };
    function myrefresh()
    {
        window.location.reload();
        console.log(1111);
    }

    function loadSVGInline()
{
    var SVGFile="{% static 'img/bdmap.svg' %}";
    var loadXML = new XMLHttpRequest;
    function handler(){

        var svgDiv = document.getElementById("map1");
        if(loadXML.readyState == 4 && loadXML.status == 200)
        {
            svgDiv.innerHTML=loadXML.responseText;


        }
    }
    if (loadXML != null){
        loadXML.open("GET", SVGFile, true);
        loadXML.onreadystatechange = handler;
        loadXML.send();

    }
}

    function getApi() {
        //设置时间 300-秒  1000-毫秒  这里设置你自己想要的时间
        setTimeout(getApi,300*1000);




        $.ajax({
            url: 'road_info/',
            type: 'get',
            dataType: 'json',
            success: function (data) {
                //方法中传入的参数data为后台获取的数据
    {#            var road_list = ['松山大桥',#}
    {#    '西羊坊隧道',#}
    {#    '京银路',#}
    {#    '康张路',#}
    {#    '京礼高速',#}
    {#    '百康路',#}
    {#    '西丁路',#}
    {#    '百泉街',#}
    {#    '湖南西路',#}
    {#    '妫水南街',#}
    {#    '京藏高速',#}
    {#    '京新高速',#}
    {#    '京承高速',#}
    {#    '万泉河路',#}
    {#    '莲花池西路',#}
    {#    '莲花池东路',#}
    {#    '大兴机场高速',#}
    {#    '崇文门东大街',#}
    {##}
    {#];#}

                var line_len = 16;
                {#var bd = '<div class="txtMarquee-top1"><ul class="infoList1" id="p1" ></ul></div><div class="txtMarquee-top2"><ul class="infoList3" id="p2"></ul></div>';#}
                {#var slide_box = '<div class="slideTxtBox">' + '<div class="hd">' + '<ul><li>事件信息</li><li>赛事信息</li></ul>' + '</div>' + bd + '</div>';#}
                {#$('.slider').html(slide_box);#}
                var road_list = [
                    '团结路',
                    '京银路',
                    '康张路',
                    '西顺城街',
                    '京原路',
                    '京平高速',
                    '京藏高速0',
                    '京藏高速1',
                    '京藏高速2',
                    '京藏高速3',
                    '京藏高速4',
                    '京藏高速5',
                    '京藏高速6',
                    '京藏高速7',
                    '京藏高速8',
                    '京藏高速9',
                    '京藏高速10',
                    '京藏高速11',
                    '京藏高速12',
                    '京藏高速13',
                    '京新高速1',
                    '京新高速2',
                    '京新高速3',
                    '京新高速4',
                    '京新高速5',
                    '京新高速7',
                    '京新高速8',
                    '京新高速9',
                    '京新高速10',
                    '京新高速11',
                    '京新高速12',
                    '京新高速13',
                    '京新高速14',
                    '京承高速',
                    '京礼高速',
                ];
                road_info = data['road'];
                events = data['event'];
                games = data['game'];
                for(var i=0;i<road_list.length;i++){
                    document.getElementById(road_list[i]).style="fill:#00b050;";

                }
                {#var animates = document.getElementsByName("animate");#}
                {#for(var i=0;i<animates.length;i++){#}
                {#    animates[i--].remove();#}
                {#}#}

                var dialogs = document.getElementsByClassName("j-dialog");
                for(var i=0;i<dialogs.length;i++){
                    console.log(dialogs);
                    dialogs[i--].remove();
                }


                var dt = new Date();
                var y = dt.getFullYear();
                var mt = dt.getMonth() + 1;
                var day = dt.getDate();
                var h = dt.getHours();//获取时
                var m = dt.getMinutes();//获取分
                var s = dt.getSeconds();//获取秒
                var minutes = (dt.getMinutes()<10?'0':'') + dt.getMinutes();
                var time =  y + "年" + mt + "月" + day + "日-" + h + "时" + m + "分";
                var hms = h + ":" + minutes ;

                var list1 = document.getElementById("p1");
                var list2 = document.getElementById("p2");
                var attr1 = '';
                var attr2 = '';
                if(road_info.length===0){
                    var dt = new Date();
                    var y = dt.getFullYear();
                    var mt = dt.getMonth() + 1;
                    var day = dt.getDate();
                    var h = dt.getHours();//获取时
                    var m = dt.getMinutes();//获取分
                    var s = dt.getSeconds();//获取秒
                    var time =  y + "年" + mt + "月" + day + "日-" + h + "时" + m + "分";
                    html = "<div>" + time + ":" + "延庆场馆周边道路全线畅通。</div>";
                    offset = {
                        top: -400,
                        left: -400,
                        right: 0,
                        bottom: 0
                    };

                    dialog = jDialog.tip(html, {
                        target: $('.anchor'),
                        position: 'top',
                        trianglePosFromStart: 100,
                        padding: '10px 5px',
                        autoClose: 1,
                        offset: offset
                    });

                }
                for(var i = 0;i<road_info.length;i++){
                    var road_name = road_info[i]['road_name'];
                    if(road_name==="京藏高速" || road_name==="京新高速"){
                        if(road_info[i]['section_id']===null){
                            road_info[i]['section_id']='5';
                        }
                        road_name = road_name + road_info[i]['section_id'];
                        console.log(road_name);
                        console.log(road_info[i]['text']);
                    }
                    var speed = parseFloat(road_info[i]['speed']);
                    var direction = parseInt(road_info[i]['direction']);
                    if (speed>=30){

                        var color = 'y'+direction;
                        document.getElementById(road_name).style="fill:url(#"+color+");";
                        {#var svgNS = "http://www.w3.org/2000/svg";#}
                        {#var carton1 = document.createElementNS(svgNS,'animate');#}
                        {#carton1.setAttribute('id',road_name + 'Ani1');#}
                        {#carton1.setAttribute('attributeType','CSS');#}
                        {#carton1.setAttribute('attributeName','fill');#}
                        {#carton1.setAttribute('from','#00b050');#}
                        {#carton1.setAttribute('to','#ffff00');#}
                        {#carton1.setAttribute('begin','0s;' + road_name + 'Ani1.end');#}
                        {#carton1.setAttribute('dur','1s');#}
                        {#carton1.setAttribute('trepeatCount','indefinite');#}
                        {##}
                        {##}
                        {#var carton2 = document.createElementNS(svgNS,'animate');#}
                        {#carton2.setAttribute('id',road_name + 'Ani2');#}
                        {#carton2.setAttribute('attributeType','CSS');#}
                        {#carton2.setAttribute('attributeName','fill');#}
                        {#carton2.setAttribute('from','#00b050');#}
                        {#carton2.setAttribute('to','#ffff00');#}
                        {#carton2.setAttribute('begin',road_name + 'Ani2.end');#}
                        {#carton2.setAttribute('dur','1s');#}
                        {#carton2.setAttribute('trepeatCount','indefinite');#}
                        {##}
                        {#document.getElementById(road_name).appendChild(carton1);#}
                        {#document.getElementById(road_name).appendChild(carton2);#}

                    }
                    else {
                        var color = 'r'+direction;
                        console.log(color);
                        document.getElementById(road_name).style="fill:url(#"+color+");";
                        {#var svgNS = "http://www.w3.org/2000/svg";#}
                        {#var carton1 = document.createElementNS(svgNS,'animate');#}
                        {#carton1.setAttribute('id',road_name + 'Ani1');#}
                        {#carton1.setAttribute('attributeType','CSS');#}
                        {#carton1.setAttribute('attributeName','fill');#}
                        {#carton1.setAttribute('from','#00b050');#}
                        {#carton1.setAttribute('to','url(#grad1)');#}
                        {#carton1.setAttribute('begin','0s;' + road_name + 'Ani1.end');#}
                        {#carton1.setAttribute('dur','1s');#}
                        {#carton1.setAttribute('trepeatCount','indefinite');#}
                        {##}
                        {##}
                        {#var carton2 = document.createElementNS(svgNS,'animate');#}
                        {#carton2.setAttribute('id',road_name + 'Ani2');#}
                        {#carton2.setAttribute('attributeType','CSS');#}
                        {#carton2.setAttribute('attributeName','fill');#}
                        {#carton2.setAttribute('from','url(#grad1)');#}
                        {#carton2.setAttribute('to','#00b050');#}
                        {#carton2.setAttribute('begin',road_name + 'Ani2.end');#}
                        {#carton2.setAttribute('dur','1s');#}
                        {#carton2.setAttribute('trepeatCount','indefinite');#}
                        {##}
                        {#document.getElementById(road_name).appendChild(carton1);#}
                        {#document.getElementById(road_name).appendChild(carton2);#}

                    }

                    var str = road_info[i]['text'];
                    var pre = '';

                    var target = $('#' + road_name);

                    console.log(target.offset());
                    html = "<div>" + str + "</div>";
                    offset = {
                        top: -target.offset().top-100+Math.max(50,Math.round(Math.random()*200)),//-target.offset().top-50,
                        left: target.offset().left-550,
                        right: 0,
                        bottom: 0
                    };

                    dialog = jDialog.tip(html, {
                        target: $('.anchor'),
                        position: 'top',
                        trianglePosFromStart: 100,
                        padding: '1px 1px',
                        width: '150px',
                        minWidth: '100px',
                        autoClose: 1,
                        offset: offset
                    });


                    while(str.length>line_len){
                        pre = str.substr(0,line_len);
                        str = str.substring(line_len);
                        let text = '<li><span style="white-space:normal;font-size:16px;">' + pre + '</li></span>';
                        attr1 += text;
                        if(str.length<=line_len){
                           attr1 +=  '<li><span style="white-space:normal;font-size:16px;">' + str + '</li></span>';
                        }

                    }
                    attr1 += '<li><span>*****************</li></span>';
                }

                for(var i = 0;i<events.length;i++){

                    var str = events[i]['date'] + ' ' + hms + ' ' + events[i]['content'];
                    var pre = '';


                    while(str.length>line_len){
                        pre = str.substr(0,line_len);
                        str = str.substring(line_len);
                        let text = '<li><span style="white-space:normal;font-size:16px;">' + pre + '</li></span>';
                        attr1 += text;
                        if(str.length<=line_len){
                           attr1 +=  '<li><span style="white-space:normal;font-size:16px;">' + str + '</li></span>';
                        }



                    }
                    attr1 += '<li><span>*****************</li></span>';
                }

                for(var i = 0;i<games.length;i++){

                    var str = games[i]['date'] + ' ' + hms + ' ' + games[i]['content'];
                    var pre = '';
                    while(str.length>line_len){
                        pre = str.substr(0,line_len);
                        str = str.substring(line_len);
                        let text = '<li><span style="white-space:normal;font-size:16px;">' + pre + '</li></span>';
                        attr2 += text;
                        if(str.length<=line_len){
                           attr2 +=  '<li><span style="white-space:normal;font-size:16px;">' + str + '</li></span>';
                        }



                    }
                    attr2 += '<li><span>*****************</li></span>';
                }




                list1.innerHTML = attr1;
                list2.innerHTML = attr2;
                $(".txtMarquee-top1").slide({mainCell:".infoList1",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});
                $(".txtMarquee-top2").slide({mainCell:".infoList2",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});
                {#$(".txtMarquee-top3").slide({mainCell:".infoList3",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});#}
                {#jQuery(".txtMarquee-top4").slide({mainCell:".infoList4",autoPlay:true,effect:"topMarquee",vis:20,interTime:50});#}
                $(".slideTxtBox").slide({ effect:"left" ,autoPlay:true, interTime:10000});
                }})
    }



    </script>

</body>
</html>