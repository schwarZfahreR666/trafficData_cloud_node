//全局变量
//大型赛事活动模式一站点
var bregion_model=[

    {"ID": "wx4g956kbxu3", "poly":[[116.40640051121127, 40.00123648206145], [116.41150752054523, 39.996946888456264],
 [116.4198921688047, 40.00214221723744], [116.41739816903876, 40.0235244582701], [116.41279144157495, 40.02523110750434],
[116.40613076764157, 40.0116938225004]],
    "FlowOut": "1604", "FlowIn": "950", "NetFlow": "-654"},
 {"ID": "wx4exffpzg20", "poly": [["116.36758678283688", " 39.99493450382268"], [" 116.36631261982923", " 40.02023555377464"], [" 116.3612672556412", " 40.025026038782215"], [" 116.35220394055844", " 40.02548711327245"], [" 116.35288233471078", " 40.000693770415644"],
         [" 116.35638269830028", " 39.99428194991918"]], "FlowOut": "900", "FlowIn": "800", "NetFlow": "-100"},


    {"ID": "wx4g956kbxu3", "poly":[[116.40640051121127, 40.00123648206145], [116.41150752054523, 39.996946888456264],
 [116.4198921688047, 40.00214221723744], [116.41739816903876, 40.0235244582701], [116.41279144157495, 40.02523110750434],
[116.40613076764157, 40.0116938225004]],
    "FlowOut": "1604", "FlowIn": "950", "NetFlow": "-654"},
	{"ID": "wx4g2v0wm521", "poly": [["116.38818277498736", " 39.968649083100146"], [" 116.41267611589788", " 39.96968760980454"], [" 116.41269153341982",
	" 39.97112287643928"], [" 116.40649107258109", " 39.97937356400532"], [" 116.3943229391871", " 39.97871850938206"]],
	"FlowOut": "600", "FlowIn": "700", "NetFlow": "100"},
	{"ID": "wx4ghfmqk4y0", "poly": [[116.57300395645271, 39.889877432764486], [116.57214947964218, 39.918423350736454],
            [116.5777236710856, 39.92352109751719], [116.59469161143643, 39.92165008790667],
            [116.59340585899923, 39.889684969690954], [116.58911478082774, 39.88781095555692]]
, "FlowOut": "200", "FlowIn": "10", "NetFlow": "-180"},
	{"ID": "wx4epcfjv4nn", "poly": [["116.3611835312926", " 39.92113654626935"], [" 116.35173301397086", " 39.92308531979975"],
	[" 116.35163667011446", " 39.90377844849085"], [" 116.35404228580963", " 39.901555601566315"], [" 116.36062764533668", " 39.90365250019365"],
	[" 116.36142312366849", " 39.90476905353463"]], "FlowOut": "500", "FlowIn": "400", "NetFlow": "-100"},
	{"ID": "wx4erye3bb5k", "poly": [["116.36758678283688", " 39.99493450382268"], [" 116.3682913554025", " 39.994543437165746"],
	[" 116.36882380111528", " 39.9675937744589"], [" 116.3678443518311", " 39.96692299546711"], [" 116.35367847763106", " 39.97956467862393"],
	[" 116.35354068985616", " 39.991428895722876"], [" 116.35638269830028", " 39.99428194991918"]],
        "FlowOut": "2800", "FlowIn": "1080", "NetFlow": "-1720"},

	{"ID": "wx4g8eqd9f3v", "poly": [["116.38683245080864", " 39.99884399687314"], [" 116.40640051121127", " 40.00123648206145"],
	[" 116.40613076764157", " 40.0116938225004"], [" 116.38615400363223", " 40.01379777682655"]],
        "FlowOut": "10300", "FlowIn": "6900", "NetFlow": "-3400"},


 ];




 bmode1_in1=[
{"AreaID":"wx4ur6un8zm1","Station":"R安立路","Lng":116.413246,"Lat":40.008831,"15-16":0,"16-17":1,"17-18":0,"18-19":1,"19-20":1,"20-21":1,"21-22":0,"22-23":3,"23-24":1},
{"AreaID":"wx4g8eqd9f3v","Station":"R奥林匹克公园","Lng":116.399208,"Lat":40.007279,"15-16":0,"16-17":1,"17-18":0,"18-19":2,"19-20":5,"20-21":5,"21-22":5,"22-23":4,"23-24":11},
{"AreaID":"wx4exffpzg20","Station":"B成府路口南","Lng":116.365931,"Lat":39.997929,"15-16":0,"16-17":1,"17-18":1,"18-19":0,"19-20":0,"20-21":1,"21-22":1,"22-23":2,"23-24":0},
{"AreaID":"wx4erye3bb5k","Station":"B蓟门桥南","Lng":116.365931,"Lat":39.97153,"15-16":0,"16-17":0,"17-18":0,"18-19":1,"19-20":0,"20-21":0,"21-22":0,"22-23":0,"23-24":0},
{"AreaID":"wx4ur6un8zm1","Station":"B豹房","Lng":116.418348,"Lat":40.01021,"15-16":0,"16-17":0,"17-18":0,"18-19":0,"19-20":0,"20-21":0,"21-22":0,"22-23":0,"23-24":0},
{"AreaID":"wx4erye3bb5k","Station":"B蓟门桥北","Lng":116.367337,"Lat":39.979214,"15-16":1,"16-17":0,"17-18":1,"18-19":0,"19-20":1,"20-21":0,"21-22":0,"22-23":1,"23-24":0},
{"AreaID":"wx4g2v0wm521","Station":"B马甸桥南","Lng":116.392509,"Lat":39.973271,"15-16":2,"16-17":2,"17-18":3,"18-19":0,"19-20":0,"20-21":0,"21-22":4,"22-23":1,"23-24":1},
{"AreaID":"wx550c1w3e6t","Station":"R双桥","Lng":116.584323,"Lat":39.916007,"15-16":5,"16-17":7,"17-18":3,"18-19":2,"19-20":1,"20-21":4,"21-22":0,"22-23":2,"23-24":1},
{"AreaID":"wx4epcfjv4nn","Station":"B天宁寺桥西","Lng":116.357029,"Lat":39.904969,"15-16":0,"16-17":0,"17-18":1,"18-19":1,"19-20":1,"20-21":0,"21-22":1,"22-23":1,"23-24":0},
{"AreaID":"wx4g956kbxu3","Station":"B洼里南口","Lng":116.408081,"Lat":40.009926,"15-16":2,"16-17":0,"17-18":1,"18-19":0,"19-20":0,"20-21":0,"21-22":2,"22-23":0,"23-24":0},
{"AreaID":"wx4erye3bb5k","Station":"R西土城","Lng":116.360647,"Lat":39.982279,"15-16":2,"16-17":1,"17-18":1,"18-19":2,"19-20":3,"20-21":0,"21-22":3,"22-23":1,"23-24":6},
{"AreaID":"wx4g8eqd9f3v","Station":"B中科院地理所","Lng":116.395964,"Lat":40.009501,"15-16":0,"16-17":0,"17-18":0,"18-19":0,"19-20":0,"20-21":0,"21-22":0,"22-23":1,"23-24":0}
];
var map;
var addedSrcId = [];
var addedLayerId = [];
var source_data = new Array();//道路数据
var timelineChart;
var graphChart;
var node_color={};
var cur_time = 0;
var cur_loc = 'DZM';
var flowdata=[];
var view;
var pointLayer;
var trafficIndex=[];
$(function(){


    loadMap();
	//mainRunningTrack();
	loadPoly();
	addTrafficIndex();
	//addMarker();
	addStations(bmode1_in1);
	addVenue();
	showTrafficRank();
 
});
function loadMap(){
    map = new BMapGL.Map("map");
    map.centerAndZoom(new BMapGL.Point(116.336573,40.000079), 14);
	map.enableScrollWheelZoom(true); // 开启鼠标滚轮缩放
	map.setDisplayOptions({
    poiText: false,  // 隐藏poi标注
    //poiIcon: false,  // 隐藏poi图标
    //building: false  // 隐藏楼块
});
  map.setMapStyleV2({     
  styleId: 'f93e20266be1e44e35abd488256458fe'
});
map.setTrafficOn(); // 叠加路况图层
		
}

// 自定义canvas
function getTextureCanvas() {
    var textureCanvas = document.createElement('canvas');
    textureCanvas.width = textureCanvas.height = 200;
    var ctx = textureCanvas.getContext('2d');
    ctx.fillStyle = '#79a913';
    ctx.strokeStyle = '#79a913';
	ctx.fillOpacity=0.9;
    ctx.lineWidth = 6;
    ctx.lineCap = 'square';
    ctx.fillRect(0, 0, 200, 200);
    ctx.moveTo(50, 50);
    ctx.lineTo(150, 50);
    ctx.lineTo(150, 150);
    ctx.lineTo(50, 150);
    ctx.lineTo(50, 50);
    ctx.stroke();
    return textureCanvas;
}
//添加场馆
function addVenue(){
	
var pStart = new BMapGL.Point(116.381452,40.018565);
var pEnd = new BMapGL.Point(116.410198,40.039006);
var bounds = new BMapGL.Bounds(new BMapGL.Point(pStart.lng, pEnd.lat), new BMapGL.Point(pEnd.lng, pStart.lat));
var canvasOverlay = new BMapGL.GroundOverlay(bounds, {
    type: 'canvas',
    url: getTextureCanvas(),
    opacity: 0.9
});
map.addOverlay(canvasOverlay);

// 添加文本标注
var opts = {
    position: new BMapGL.Point(116.3980000,40.025084),
    offset: new BMapGL.Size(-93, -55)
};
var label = new BMapGL.Label('奥林匹克森林公园', opts);
label.setStyle({
    color: '#fff',
    borderRadius: '5px',
    borderColor: '#fff',
    backgroundColor: '#79a913',
    fontSize: '20px',
    height: '40px',
    lineHeight: '35px',
	maxWidth:"none",
	
});
//label.setZIndex(zIndex:1);
map.addOverlay(label);

}

function loadPoly(){
	// 根据出入流量显示不同颜色
//>5000红色；>1000黄色；>500蓝色；>100粉色；其余是绿色
var region_o1=[];
var region_o2=[];
var region_o3=[];
var region_o4=[];
var region_o5=[];
var trafficIndexSum=0.0;
var regionWithTrafficIndex=bregion_model;

var polyColor=[];
//计算交通指数总和
for(var i=0;i<bregion_model.length;i++){
	trafficIndexSum=trafficIndexSum+Math.abs(bregion_model[i]["NetFlow"]);
}
//计算每个区域的交通指数
for(var i=0;i<bregion_model.length;i++){
	var temp;
	temp=5*(Math.abs(bregion_model[i]["NetFlow"]))/(trafficIndexSum*1.0);
	trafficIndex.push(temp.toFixed(2));
}
//为每个多边形添加交通指数属性
for(var i=0;i<bregion_model.length;i++){
	regionWithTrafficIndex[i]['trafficIndex']=trafficIndex[i];
	if(trafficIndex[i]>=0.5){
		polyColor.push('#FF0000');
	}
	else if(trafficIndex[i]>=0.1){
		polyColor.push('#FFA500');
	}
	else {
		polyColor.push('#00FF7F');
	}
}
//console.log(trafficIndex);
//console.log(polyColor);

//绘制多边形区域
var polygon;
for(var i=0;i<regionWithTrafficIndex.length;i++){
var lines=[];
//根据交通指数分别绘制多边形
for(var j=0;j<regionWithTrafficIndex[i]["poly"].length;j++){
lines.push(new BMapGL.Point(regionWithTrafficIndex[i]["poly"][j][0], regionWithTrafficIndex[i]["poly"][j][1]));
}
polygon = new BMapGL.Polygon(lines, {
    strokeColor: '#FFFFFF',
    strokeWeight: 2,
    strokeOpacity: 0.5,
	fillColor: polyColor[i]
});
map.addOverlay(polygon);

}
}
//获取多边形的中心点
function getCenterPoint(path) {
  //var path =e.;//Array<Point> 返回多边型的点数组
  //var ret=parseFloat(num1)+parseFloat(num2);
  //console.log(path);
  var x = 0.0;
  var y = 0.0;
  for (var i = 0; i < path.length; i++) {
    x = x + parseFloat(path[i][0]);
    y = y + parseFloat(path[i][1]);
  }
  x = x / path.length;
  y = y / path.length;

  //return new BMap.Point(path[0].lng,path[0].lat);
  return new BMapGL.Point(x, y);
  //return path[0];
}

//添加每个区域的交通指数
function addTrafficIndex(){
	for(var i=0;i<bregion_model.length;i++){

		var point=getCenterPoint(bregion_model[i]["poly"]);
		
		var opts = {    
        position : point,    // 指定文本标注所在的地理位置    
        offset   : new BMapGL.Size(0, 0)    //设置文本偏移量    
       }    
     var label = new BMapGL.Label(trafficIndex[i], opts);  // 创建文本标注对象    
        label.setStyle({    
        color : "BLUE", 
		fontSize : "16px",
		height : "20px",
		lineHeight : "20px",
		fontFamily:"微软雅黑",　
		maxWidth:"none",
		backgroundColor: "0.000000000001", 
		border:"0"		
        });    
      map.addOverlay(label);  	
		
	}

   
}
//添加区域重要公交地铁站点
function addMarker(){
	//重要公交站点
	var stations=[
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥东","Lng":116.38552,"Lat":40.00913615,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B二里庄北口","Lng":116.3752704,"Lat":40.00878817,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B南沙滩","Lng":116.3865837,"Lat":40.00363204,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B双泉堡","Lng":116.3775527,"Lat":40.01555985,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北京科技大学北门","Lng":116.3718818,"Lat":40.00088441,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥西","Lng":116.3796061,"Lat":40.00882345,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新路","Lng":116.3800677,"Lat":40.00137604,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新路东口","Lng":116.3854707,"Lat":40.00164418,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B二里庄","Lng":116.3775653,"Lat":40.0067989,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B二里庄南口","Lng":116.3777683,"Lat":40.00233387,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新北里","Lng":116.381759,"Lat":40.00074348,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B中国农业大学东校区","Lng":116.3696507,"Lat":40.00850902,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B科荟路西口","Lng":116.3699537,"Lat":40.01520523,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R北沙滩","Lng":116.3748462,"Lat":40.00749515,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新桥北","Lng":116.3820132,"Lat":39.99584476,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥南","Lng":116.383371,"Lat":40.00781286,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥北","Lng":116.3814279,"Lat":40.01037694,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B双泉堡南","Lng":116.3793873,"Lat":40.01308101,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R北京科技大学北门","Lng":116.3718818,"Lat":40.00088441,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩","Lng":116.3748462,"Lat":40.00749515,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R北沙滩桥东","Lng":116.38552,"Lat":40.00913615,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R二里庄南口","Lng":116.3777683,"Lat":40.00233387,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R志新路","Lng":116.3800677,"Lat":40.00137604,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B双泉堡东","Lng":116.3788059,"Lat":40.01714662,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R奥林匹克公园","Lng":116.3992082,"Lat":40.00727944,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B奥运村西","Lng":116.388364,"Lat":40.01248452,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B中科院地理所","Lng":116.3959637,"Lat":40.00950142,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B南沟泥河","Lng":116.3915035,"Lat":40.0095468,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B国家体育馆","Lng":116.3998868,"Lat":40.00342605,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B科学园南里","Lng":116.3939891,"Lat":40.0054449,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B科学园南里中街","Lng":116.3931255,"Lat":40.00693123,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔桥北","Lng":116.3881932,"Lat":40.00240182,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔桥南","Lng":116.3887805,"Lat":40.00080926,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔北路西口","Lng":116.393671,"Lat":40.00198966,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B新闻中心","Lng":116.3994991,"Lat":40.0085419,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R南沟泥河","Lng":116.3915035,"Lat":40.0095468,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R安翔北路西口","Lng":116.393671,"Lat":40.00198966,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B奥林匹克公园","Lng":116.3992082,"Lat":40.00727944,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R奥运村西","Lng":116.388364,"Lat":40.01248452,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R国家体育馆","Lng":116.3998868,"Lat":40.00342605,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔北路东口","Lng":116.3988158,"Lat":40.00222076,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R中科院地理所","Lng":116.3959637,"Lat":40.00950142,"":"aosen"},
{"AreaID":"wx4ex3x2kwc7","Station":"R五道口","Lng":116.34444771316686,"Lat":39.99844346071147,"":"aosen"},
];
console.log(stations);
	// 创建点标记
	for(var i=0;i<stations.length;i++){
		var marker = new BMapGL.Marker(new BMapGL.Point(stations[i]['Lng'], stations[i]['Lat']));	
        map.addOverlay(marker);
	}
}

////行车路线规划实例
function RoadStatus(p1,p2,color){
	//console.log(color);
 var transit = new BMapGL.TransitRoute(map,{
            renderOptions: {map: map, autoViewport: false},onMarkersSet:function(routes) {
		  //当地图标记添加完成时调用
				for (var i = 0; i <routes.length; i++) {
						//判断是否是途经点
						if(typeof(routes[i].Km)=="undefined"){
								map.removeOverlay(routes[i].marker); //删除起始默认图标
						}else{
								map.removeOverlay(routes[i].Km); //删除途经默认图标
						}
				}
			}
        });
	    transit.search(p1, p2);
		}
//添加重点站点（奥林匹克公园站R和国家体育馆B）的路线	
function mainRunningTrack(){
	//奥林匹克公园站R	116.3992082,40.00727944
	//国家体育馆B	116.3998868,40.00342605
	//北京西R 		116.327811,39.900677
	//北京西B		116.328103,39.900835
	//首都机场		116.609564,40.083812
	//(116.39596370968889,40.009501418660314)//B中科院地理所,
	//(116.38551997526146,40.00913615115001)//R北沙滩桥东
	//116.424499,40.006865 汉庭优佳酒店(亚运村鸟巢新店)
	//116.378388,40.040981 丽枫酒店(鸟巢店)
	//116.414285,40.008946安立路地铁站
	var p1=new BMapGL.Point(116.3992082,40.00727944);//奥林匹克公园站R
	var p2=new BMapGL.Point(116.327811,39.900677);//北京西R
	var p3=new BMapGL.Point(116.3992082,40.00727944);//奥林匹克公园站R
	var p4=new BMapGL.Point(116.609564,40.083812);//首都机场
	var p5=new BMapGL.Point(116.38551997526146,40.00913615115001)//R北沙滩桥东
	var p6=new BMapGL.Point(116.327811,39.900677);//北京西R
	var p7=new BMapGL.Point(116.3992082,40.00727944);//奥林匹克公园站R
	var p8=new BMapGL.Point(116.424499,40.006865);// 汉庭优佳酒店(亚运村鸟巢新店)
	var p9=new BMapGL.Point(116.38551997526146,40.00913615115001);//R北沙滩桥东
	var p10=new BMapGL.Point(116.378388,40.040981); //丽枫酒店(鸟巢店)
	var p11=new BMapGL.Point(116.414285,40.008946); //安立路R
	var color='#00BFFF';
	var color1='#00BFFF';
	RoadStatus(p1,p2,color);
	RoadStatus(p3,p4,color);
	RoadStatus(p5,p6,color);
	RoadStatus(p5,p6,color);
	RoadStatus(p3,p11,color1);
	RoadStatus(p9,p10,color1);
	
	
}

function addStations(stations){
	//console.log(stations);
	//处理数据
	var flowdata=[];
	
	for(var i=0;i<stations.length;i++){
	var temp=[];
		temp.push(stations[i]['AreaID']);
		temp.push(stations[i]['Station']);
		temp.push(parseFloat(stations[i]['Lng']));
		temp.push(parseFloat(stations[i]['Lat']));
		flowdata.push(temp);
}


console.log(flowdata);
//添加公交站点信息窗口和公交站点标识
	for(var p=0;p<flowdata.length;p++){
		
	var opts = {
    position: new BMapGL.Point(flowdata[p][2], flowdata[p][3]), // 指定文本标注所在的地理位置
    offset: new BMapGL.Size(10, -30) // 设置文本偏移量
};
// 创建文本标注对象
var str;
if(flowdata[p][1].substr(0,1)=='B'){
	str=flowdata[p][1].substr(1,flowdata[p][1].length-1)+"公交站"
}
if(flowdata[p][1].substr(0,1)=='R')
{
	str=flowdata[p][1].substr(1,flowdata[p][1].length-1)+"地铁站"
}
var marker = new BMapGL.Marker(new BMapGL.Point(flowdata[p][2], flowdata[p][3]));
map.addOverlay(marker);
var label = new BMapGL.Label(str, opts);  // 创建文本标注对象
        label.setStyle({
             color : "black",
             fontSize : "10px",
             height : "15px",
             lineHeight : "12px",
             fontFamily:"微软雅黑",
			 backgroundColor :"white", //文本标注背景颜色　
			 maxWidth:"none",
			 border:"0"
         });
    map.addOverlay(label);  
	}
	
}
//客流量动态排序
function showTrafficRank(){
    myChart = echarts.init(document.getElementById('trafficRank'));
	var updateFrequency = 8000;
	var dimension = 0;

	//var countryColors = {"Australia":"#00008b","Canada":"#f00","China":"#ffde00","Cuba":"#002a8f","Finland":"#003580","France":"#ed2939","Germany":"#000","Iceland":"#003897","India":"#f93","Japan":"#bc002d","North Korea":"#024fa2","South Korea":"#000","New Zealand":"#00247d","Norway":"#ef2b2d","Poland":"#dc143c","Russia":"#d52b1e","Turkey":"#e30a17","United Kingdom":"#00247d","United States":"#b22234"};


    //var flags = res0[0];
    //var data = res1[0];
	var flags=[{code: "AD", emoji: "🇦🇩", unicode: "U+1F1E6 U+1F1E9", name: "Andorra", title: "flag for Andorra"},
	{code: "AE", emoji: "🇦🇪", unicode: "U+1F1E6 U+1F1EA", name: "United Arab Emirates", title: "flag for United Arab Emirates"},
	{code: "AF", emoji: "🇦🇫", unicode: "U+1F1E6 U+1F1EB", name: "Afghanistan", title: "flag for Afghanistan"}];
	
	var data=[["Income", "Life Expectancy", "Population", "Country", "Year"],
	[815, 34.05, 351014, "Australia", 1800],[1314, 39, 645526, "Canada", 1800],
	[985, 32, 321675013, "China", 1800],[864, 32.2, 345043, "Cuba", 1800]];
	
    var years = [];
    for (var i = 0; i < data.length; ++i) {
        if (years.length === 0 || years[years.length - 1] !== data[i][4]) {
            years.push(data[i][4]);
        }
    }

    function getFlag(countryName) {
        if (!countryName) {
            return '';
        }
        return (flags.find(function (item) {
            return item.name === countryName;
        }) || {}).emoji;
    }
    var startIndex = 10;
    var startYear = years[startIndex];

    var option = {
        grid: {
            top: 10,
            bottom: 30,
            left: 150,
            right: 80
        },
        xAxis: {
            max: 'dataMax',
            label: {
                formatter: function (n) {
                    return Math.round(n);
                }
            }
        },
        dataset: {
            source: data.slice(1).filter(function (d) {
                return d[4] === startYear;
            })
        },
        yAxis: {
            type: 'category',
            inverse: true,
            max: 10,
            axisLabel: {
                show: true,
                textStyle: {
                    fontSize: 14
                },
                formatter: function (value) {
                    return value + '{flag|' + getFlag(value) + '}';
                },
                rich: {
                    flag: {
                        fontSize: 25,
                        padding: 5
                    }
                }
            },
            animationDuration: 300,
            animationDurationUpdate: 300
        },
        series: [{
            realtimeSort: true,
            seriesLayoutBy: 'column',
            type: 'bar',
            itemStyle: {
                color: function (param) {
                    return countryColors[param.value[3]] || '#5470c6';
                }
            },
            encode: {
                x: dimension,
                y: 3
            },
            label: {
                show: true,
                precision: 1,
                position: 'right',
                valueAnimation: true,
                fontFamily: 'monospace'
            }
        }],
        // Disable init animation.
        animationDuration: 0,
        animationDurationUpdate: updateFrequency,
        animationEasing: 'linear',
        animationEasingUpdate: 'linear',
        graphic: {
            elements: [{
                type: 'text',
                right: 160,
                bottom: 60,
                style: {
                    text: startYear,
                    font: 'bolder 80px monospace',
                    fill: 'rgba(100, 100, 100, 0.25)'
                },
                z: 100
            }]
        }
    };

    // console.log(option);
    myChart.setOption(option);

    for (var i = startIndex; i < years.length - 1; ++i) {
        (function (i) {
            setTimeout(function () {
                updateYear(years[i + 1]);
            }, (i - startIndex) * updateFrequency);
        })(i);
		console.log("动态图表测试！")
    }

    function updateYear(year) {
        var source = data.slice(1).filter(function (d) {
            return d[4] === year;
        });
        option.series[0].data = source;
        option.graphic.elements[0].style.text = year;
        myChart.setOption(option);
    }

		

}










		


