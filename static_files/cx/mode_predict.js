//全局变量
//大型赛事活动模式一站点
var bregion_model=[{"ID": "wx4g8b2523sf", "poly": [["116.39407262665172", " 39.9874278071865"], [" 116.40645338321958", " 39.98802627416739"],
 [" 116.41164915247421", " 39.995198241507474"], [" 116.41150752054523", " 39.996946888456264"], [" 116.40640051121127", " 40.00123648206145"], 
 [" 116.38683245080864", " 39.99884399687314"], [" 116.38625335572335", " 39.99787841243853"]], "FlowOut": "391", "FlowIn": "352", "NetFlow": "-39"},
 {"ID": "wx4g85jkq7ex", "poly": [["116.38625335572335", " 39.99787841243853"], [" 116.38683245080864", " 39.99884399687314"], 
 [" 116.38615400363223", " 40.01379777682655"], [" 116.38543250925653", " 40.01575130183423"], [" 116.36631261982923", " 40.02023555377464"], 
 [" 116.36758678283688", " 39.99493450382268"], [" 116.3682913554025", " 39.994543437165746"], [" 116.3817266587883", " 39.99545639935533"]], "FlowOut": "1074",
 "FlowIn": "1016", "NetFlow": "-58"}, 
 {"ID": "wx4ur6un8zm1", "poly": [[116.43376552312212, 40.023098560924296], [116.44403498711968, 40.027607845983816], [116.4500258875249, 40.02709749135176], 
  [116.45244602588772, 40.02252808166432],[116.44460524184504, 39.996310978556444], [116.4361381436497, 39.99451725550756],
  [116.42921172206285, 40.00194062936727]], "FlowOut": "281", "FlowIn": "622", "NetFlow": "341"},
 {"ID": "wx4exffpzg20", "poly": [["116.36758678283688", " 39.99493450382268"], [" 116.36631261982923", " 40.02023555377464"], 
 [" 116.3612672556412", " 40.025026038782215"], [" 116.35220394055844", " 40.02548711327245"], [" 116.35288233471078", " 40.000693770415644"], 
 [" 116.35638269830028", " 39.99428194991918"]], "FlowOut": "6830", "FlowIn": "4657", "NetFlow": "-2173"},
 {"ID": "wx4dxyc239r5", "poly": [["116.36104748573739",
 " 39.873456861133"], [" 116.36776184686352", " 39.8557972024749"], [" 116.36788652817154", " 39.84737059603178"], [" 116.36102886404586", " 39.83334428561109"],
 [" 116.35078730825559", " 39.82898902287303"], [" 116.34722342318211", " 39.8724394517953"], [" 116.3536401161379", " 39.874615630370926"]], 
 "FlowOut": "676", "FlowIn": "87", "NetFlow": "-589"}, 
 {"ID": "wx4g3n8zu7nz", "poly": [["116.40645338321958", " 39.98802627416739"],
 [" 116.41164915247421", " 39.995198241507474"], [" 116.41816863070486", " 39.98843702553016"], [" 116.41816502838718", " 39.97866730161756"],
 [" 116.41269153341982", " 39.97112287643928"], [" 116.40649107258109", " 39.97937356400532"]], "FlowOut": "276", "FlowIn": "16", "NetFlow": "-260"}, 
 {"ID": "wx4g2qxj2m4j", "poly": [["116.38704434738031", " 39.967841938105266"], [" 116.38245808786654", " 39.96917544255928"], 
 [" 116.3817266587883", " 39.99545639935533"], [" 116.38625335572335", " 39.99787841243853"], [" 116.39407262665172", " 39.9874278071865"],
 [" 116.3943229391871", " 39.97871850938206"], [" 116.38818277498736", " 39.968649083100146"]], "FlowOut": "25", "FlowIn": "300", "NetFlow": "275"},
 {"ID": "wx4g928yr92r", "poly": [["116.41164915247421", " 39.995198241507474"], [" 116.41816863070486", " 39.98843702553016"], 
 [" 116.43316157135355", " 39.98914658882771"], [" 116.4361381436497", " 39.99451725550756"], [" 116.42921172206285", " 40.00194062936727"],
 [" 116.4198921688047", " 40.00214221723744"], [" 116.41150752054523", " 39.996946888456264"]], "FlowOut": "13", "FlowIn": "268", "NetFlow": "255"},
 {"ID": "wx4g2v0wm521", "poly": [["116.38818277498736", " 39.968649083100146"], [" 116.41267611589788", " 39.96968760980454"], 
 [" 116.41269153341982", " 39.97112287643928"], [" 116.40649107258109", " 39.97937356400532"], [" 116.3943229391871", " 39.97871850938206"]],
 "FlowOut": "1624", "FlowIn": "1129", "NetFlow": "-495"},
 {"ID": "wx4g8eqd9f3v", "poly": [["116.38683245080864", " 39.99884399687314"], [" 116.40640051121127", " 40.00123648206145"], 
 [" 116.40613076764157", " 40.0116938225004"], [" 116.38615400363223", " 40.01379777682655"]], "FlowOut": "32902", "FlowIn": "21796", "NetFlow": "-11106"},
 {"ID": "wx4dzqb15j2f", "poly": [["116.32807181333327", " 39.894018761761274"], [" 116.33279621618296", " 39.873232647226125"],
 [" 116.33349852281354", " 39.87249124934724"], [" 116.33368639638529", " 39.87245982935269"], [" 116.33837530334304", " 39.87304007406992"],
 [" 116.33885754530205", " 39.904591455986164"], [" 116.33674033791604", " 39.905791575875604"]], "FlowOut": "1916", "FlowIn": "2927", "NetFlow": "1011"}, 
 {"ID": "wx4g956kbxu3", "poly": [["116.40640051121127", " 40.00123648206145"], [" 116.41150752054523", " 39.996946888456264"], 
 [" 116.4198921688047", " 40.00214221723744"], [" 116.41739816903876", " 40.0235244582701"], [" 116.41279144157495", " 40.02523110750434"],
 [" 116.40613076764157", " 40.0116938225004"]], "FlowOut": "1564", "FlowIn": "918", "NetFlow": "-646"}, 
 
 {"ID": "wx4ep3zq20p7", "poly": [["116.336030938472", " 39.906721413139756"],
 [" 116.33618634167766", " 39.91980189901589"], [" 116.34507756326873", " 39.92618447560267"], [" 116.35013166386854", " 39.92487791151423"],
 [" 116.35173301397086", " 39.92308531979975"], [" 116.35163667011446", " 39.90377844849085"], [" 116.33885754530205", " 39.904591455986164"], 
 [" 116.33674033791604", " 39.905791575875604"]], "FlowOut": "771", "FlowIn": "573", "NetFlow": "-198"}, 
 {"ID": "wx4dzpem3fyx", "poly": [["116.32142851033664", " 39.89927314998531"],
 [" 116.32377546107116", " 39.906943151772396"], [" 116.336030938472", " 39.906721413139756"], [" 116.33674033791604", " 39.905791575875604"],
 [" 116.32807181333327", " 39.894018761761274"]], "FlowOut": "25767", "FlowIn": "36185", "NetFlow": "10418"},
{"ID": "wx4epcfjv4nn", "poly": [["116.3611835312926", " 39.92113654626935"], [" 116.35173301397086", " 39.92308531979975"], 
[" 116.35163667011446", " 39.90377844849085"], [" 116.35404228580963", " 39.901555601566315"], [" 116.36062764533668", " 39.90365250019365"],
 [" 116.36142312366849", " 39.90476905353463"]], "FlowOut": "852", "FlowIn": "848", "NetFlow": "-4"},  
 {"ID": "wx4g9795rxf3", "poly": [["116.41739816903876", " 40.0235244582701"], [" 116.4198921688047", " 40.00214221723744"], [" 116.42921172206285",
 " 40.00194062936727"], [" 116.43376552312212", " 40.023098560924296"]], "FlowOut": "0", "FlowIn": "458", "NetFlow": "458"},
  
 {"ID": "wx4erye3bb5k", "poly": [["116.36758678283688",
 " 39.99493450382268"], [" 116.3682913554025", " 39.994543437165746"], [" 116.36882380111528", " 39.9675937744589"], [" 116.3678443518311", " 39.96692299546711"],
 [" 116.35367847763106", " 39.97956467862393"], [" 116.35354068985616", " 39.991428895722876"], [" 116.35638269830028", " 39.99428194991918"]], "FlowOut": "16299",
 "FlowIn": "5664", "NetFlow": "-10635"}, 
 
 {"ID": "wx4g1986x77u", "poly": [["116.42828859806285", " 39.91011940790363"], [" 116.43198934139404", " 39.91951661805604"], 
 [" 116.43458539592535", " 39.921538503742"], [" 116.4402334917646", " 39.907147271402486"], [" 116.43333039766296", " 39.903134427068764"],
 [" 116.43009699786562", " 39.905176930387725"]], "FlowOut": "788", "FlowIn": "970", "NetFlow": "182"}, 
 {"ID": "wx4g2y8rd3tn", "poly": [[116.3943229391871, 39.97871850938206], [116.40649107258109, 39.97937356400532], [116.40645338321958, 39.98802627416739], [116.39407262665172, 39.9874278071865]],
 "FlowOut": "94", "FlowIn": "395", "NetFlow": "301"},  
  {"ID": "wx4g2nwet9z1", "poly": [[116.38245808786654, 39.96917544255928], [116.36882380111528, 39.9675937744589], [116.3682913554025, 39.994543437165746], [116.3817266587883, 39.99545639935533]],
  "FlowOut": "398", "FlowIn": "392", "NetFlow": "-6"}, 
 ];




 bmode1_in1=[
{"AreaID":"wx4g8b2523sf","Station":"B北辰西桥南","Lng":116.400433,"Lat":39.991979,"15-16":17,"16-17":9,"17-18":29,"18-19":32,"19-20":12,"20-21":13,"21-22":11,"22-23":7,"23-24":0},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥东","Lng":116.38552,"Lat":40.009136,"15-16":89,"16-17":113,"17-18":150,"18-19":193,"19-20":221,"20-21":112,"21-22":66,"22-23":52,"23-24":20},
{"AreaID":"wx4ur6un8zm1","Station":"B黄草湾","Lng":116.445496,"Lat":40.014241,"15-16":15,"16-17":34,"17-18":59,"18-19":58,"19-20":39,"20-21":21,"21-22":15,"22-23":17,"23-24":0},
{"AreaID":"wx4erye3bb5k","Station":"B蓟门桥北","Lng":116.367337,"Lat":39.979214,"15-16":0,"16-17":2,"17-18":0,"18-19":2,"19-20":2,"20-21":0,"21-22":0,"22-23":0,"23-24":0},
{"AreaID":"wx4exffpzg20","Station":"B学院路北口","Lng":116.365599,"Lat":40.004284,"15-16":62,"16-17":72,"17-18":129,"18-19":176,"19-20":110,"20-21":81,"21-22":56,"22-23":25,"23-24":11},
{"AreaID":"wx4dxyc239r5","Station":"B玉泉营桥","Lng":116.358375,"Lat":39.858508,"15-16":4,"16-17":11,"17-18":21,"18-19":18,"19-20":16,"20-21":3,"21-22":12,"22-23":2,"23-24":0},
{"AreaID":"wx4g3n8zu7nz","Station":"B安贞桥西","Lng":116.414278,"Lat":39.976395,"15-16":0,"16-17":6,"17-18":3,"18-19":3,"19-20":1,"20-21":2,"21-22":1,"22-23":0,"23-24":0},
{"AreaID":"wx4g2qxj2m4j","Station":"B马甸桥北","Lng":116.393454,"Lat":39.981353,"15-16":8,"16-17":1,"17-18":9,"18-19":16,"19-20":3,"20-21":10,"21-22":2,"22-23":1,"23-24":0},
{"AreaID":"wx4g928yr92r","Station":"B安慧桥北","Lng":116.420239,"Lat":40.000796,"15-16":16,"16-17":11,"17-18":9,"18-19":5,"19-20":5,"20-21":5,"21-22":3,"22-23":2,"23-24":0},
{"AreaID":"wx4g2v0wm521","Station":"B马甸桥东","Lng":116.398489,"Lat":39.976262,"15-16":0,"16-17":0,"17-18":1,"18-19":0,"19-20":1,"20-21":0,"21-22":0,"22-23":0,"23-24":0},

{"AreaID":"wx4ur6un8zm1","Station":"R安立路","Lng":116.413246,"Lat":40.008831,"15-16":277,"16-17":362,"17-18":555,"18-19":810,"19-20":599,"20-21":244,"21-22":181,"22-23":201,"23-24":26},
{"AreaID":"wx4g8eqd9f3v","Station":"R奥林匹克公园","Lng":116.399208,"Lat":40.007279,"15-16":1187,"16-17":3923,"17-18":8547,"18-19":4484,"19-20":2014,"20-21":915,"21-22":433,"22-23":225,"23-24":68},
{"AreaID":"wx4ur6un8zm1","Station":"B豹房","Lng":116.418348,"Lat":40.01021,"15-16":96,"16-17":153,"17-18":176,"18-19":152,"19-20":120,"20-21":88,"21-22":76,"22-23":49,"23-24":15},
{"AreaID":"wx4dzqb15j2f","Station":"B北京西站","Lng":116.335726,"Lat":39.904248,"15-16":349,"16-17":466,"17-18":514,"18-19":461,"19-20":472,"20-21":275,"21-22":236,"22-23":112,"23-24":42},
{"AreaID":"wx4g8eqd9f3v","Station":"B国家体育馆","Lng":116.399887,"Lat":40.003426,"15-16":15,"16-17":47,"17-18":79,"18-19":62,"19-20":56,"20-21":27,"21-22":8,"22-23":8,"23-24":1},
{"AreaID":"wx4g956kbxu3","Station":"B洼里南口","Lng":116.408081,"Lat":40.009926,"15-16":86,"16-17":126,"17-18":177,"18-19":182,"19-20":138,"20-21":105,"21-22":54,"22-23":30,"23-24":20},
{"AreaID":"wx4ep3zq20p7","Station":"B小马厂","Lng":116.347773,"Lat":39.90444,"15-16":87,"16-17":71,"17-18":122,"18-19":108,"19-20":82,"20-21":59,"21-22":25,"22-23":16,"23-24":3},
{"AreaID":"wx4g8eqd9f3v","Station":"B中科院地理所","Lng":116.395964,"Lat":40.009501,"15-16":62,"16-17":115,"17-18":89,"18-19":141,"19-20":140,"20-21":102,"21-22":44,"22-23":40,"23-24":1},
{"AreaID":"wx4dzpem3fyx","Station":"R北京西站","Lng":116.327931,"Lat":39.90082,"15-16":3876,"16-17":4437,"17-18":6412,"18-19":6185,"19-20":5553,"20-21":5114,"21-22":3239,"22-23":1089,"23-24":280},

{"AreaID":"wx4epcfjv4nn","Station":"B白云桥西","Lng":116.3535,"Lat":39.904747,"15-16":13,"16-17":28,"17-18":90,"18-19":59,"19-20":44,"20-21":29,"21-22":20,"22-23":7,"23-24":9},
{"AreaID":"wx4erye3bb5k","Station":"B北京航空航天大学","Lng":116.366615,"Lat":39.990008,"15-16":96,"16-17":132,"17-18":180,"18-19":236,"19-20":144,"20-21":101,"21-22":79,"22-23":32,"23-24":10},
{"AreaID":"wx4exffpzg20","Station":"B成府路口南","Lng":116.365931,"Lat":39.997929,"15-16":77,"16-17":106,"17-18":226,"18-19":308,"19-20":193,"20-21":123,"21-22":109,"22-23":44,"23-24":13},
{"AreaID":"wx4g9795rxf3","Station":"B大屯东","Lng":116.422024,"Lat":40.010749,"15-16":35,"16-17":54,"17-18":69,"18-19":109,"19-20":82,"20-21":45,"21-22":23,"22-23":35,"23-24":6},
{"AreaID":"wx4erye3bb5k","Station":"B蓟门桥南","Lng":116.365931,"Lat":39.97153,"15-16":57,"16-17":68,"17-18":107,"18-19":116,"19-20":73,"20-21":76,"21-22":67,"22-23":26,"23-24":2},
{"AreaID":"wx4g2v0wm521","Station":"B马甸桥南","Lng":116.392509,"Lat":39.973271,"15-16":153,"16-17":166,"17-18":222,"18-19":253,"19-20":172,"20-21":86,"21-22":60,"22-23":14,"23-24":3},
{"AreaID":"wx4epcfjv4nn","Station":"B天宁寺桥西","Lng":116.357029,"Lat":39.904969,"15-16":87,"16-17":141,"17-18":145,"18-19":173,"19-20":102,"20-21":97,"21-22":44,"22-23":50,"23-24":9},
{"AreaID":"wx4erye3bb5k","Station":"R西土城","Lng":116.360647,"Lat":39.982279,"15-16":606,"16-17":618,"17-18":880,"18-19":1231,"19-20":905,"20-21":461,"21-22":460,"22-23":423,"23-24":80},


{"AreaID":"wx4dxyc239r5","Station":"B菜户营桥南","Lng":116.360782,"Lat":39.87333,"15-16":7,"16-17":3,"17-18":2,"18-19":8,"19-20":2,"20-21":6,"21-22":3,"22-23":0,"23-24":0},
{"AreaID":"wx4g9795rxf3","Station":"B大屯路东口","Lng":116.429481,"Lat":40.010466,"15-16":4,"16-17":7,"17-18":34,"18-19":0,"19-20":32,"20-21":3,"21-22":0,"22-23":0,"23-24":0},
{"AreaID":"wx4g9795rxf3","Station":"B科荟路东口","Lng":116.427689,"Lat":40.016887,"15-16":21,"16-17":39,"17-18":26,"18-19":26,"19-20":71,"20-21":24,"21-22":24,"22-23":6,"23-24":10},
{"AreaID":"wx4g8eqd9f3v","Station":"B南沟泥河","Lng":116.391503,"Lat":40.009547,"15-16":116,"16-17":168,"17-18":216,"18-19":257,"19-20":172,"20-21":122,"21-22":97,"22-23":57,"23-24":12},
{"AreaID":"wx550c1w3e6t","Station":"R双桥","Lng":116.584323,"Lat":39.916007,"15-16":652,"16-17":738,"17-18":1438,"18-19":2593,"19-20":2971,"20-21":1685,"21-22":1001,"22-23":913,"23-24":427},
{"AreaID":"wx4erye3bb5k","Station":"B学知桥北","Lng":116.366991,"Lat":39.985365,"15-16":16,"16-17":25,"17-18":52,"18-19":39,"19-20":43,"20-21":20,"21-22":29,"22-23":14,"23-24":0},
{"AreaID":"wx4dxyc239r5","Station":"B玉泉营桥北","Lng":116.360185,"Lat":39.864402,"15-16":58,"16-17":54,"17-18":102,"18-19":113,"19-20":81,"20-21":34,"21-22":29,"22-23":10,"23-24":12},
{"AreaID":"wx4g1986x77u","Station":"R北京站","Lng":116.433633,"Lat":39.911149,"15-16":121,"16-17":141,"17-18":121,"18-19":115,"19-20":128,"20-21":69,"21-22":130,"22-23":118,"23-24":27},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔桥南","Lng":116.38878,"Lat":40.000809,"15-16":0,"16-17":0,"17-18":5,"18-19":0,"19-20":0,"20-21":0,"21-22":2,"22-23":0,"23-24":0},

];
var map;
var addedSrcId = [];
var addedLayerId = [];
var source_data = new Array();//道路数据
var timelineChart;
var graphChart;
var node_color={};
var cur_time = 0;
var cur_loc = 'DZM';
var flowdata=[];
var view;
var pointLayer;
var trafficIndex=[];
$(function(){


    loadMap();
	//mainRunningTrack();
	loadPoly();
	addTrafficIndex();
	//addMarker();
	addStations(bmode1_in1);
	addVenue();
	$.when( { testing: 123 } ).done(
    function(x) { 
	
	 myChart = echarts.init(document.getElementById('trafficRank'));
	var updateFrequency = 8000;
	var dimension = 0;

	//var countryColors = {"Australia":"#00008b","Canada":"#f00","China":"#ffde00","Cuba":"#002a8f","Finland":"#003580","France":"#ed2939","Germany":"#000","Iceland":"#003897","India":"#f93","Japan":"#bc002d","North Korea":"#024fa2","South Korea":"#000","New Zealand":"#00247d","Norway":"#ef2b2d","Poland":"#dc143c","Russia":"#d52b1e","Turkey":"#e30a17","United Kingdom":"#00247d","United States":"#b22234"};


    //var flags = res0[0];
    //var data = res1[0];
	var flags=[{code: "AD", emoji: "🇦🇩", unicode: "U+1F1E6 U+1F1E9", name: "Andorra", title: "flag for Andorra"},
	{code: "AE", emoji: "🇦🇪", unicode: "U+1F1E6 U+1F1EA", name: "United Arab Emirates", title: "flag for United Arab Emirates"},
	{code: "AF", emoji: "🇦🇫", unicode: "U+1F1E6 U+1F1EB", name: "Afghanistan", title: "flag for Afghanistan"}];
	
	var data=[["Income", "Life Expectancy", "Population", "Country", "Year"],
	[815, 34.05, 351014, "Australia", 1800],[1314, 39, 645526, "Canada", 1800],
	[1400, 39.01496774, 727603, "Canada", 1810],
	[1491, 39.02993548, 879432, "Canada", 1820],
	[1651, 39.04490323, 1202146, "Canada", 1830],
	[985, 32, 321675013, "China", 1800],[864, 32.2, 345043, "Cuba", 1800]];
	
    var years = [];
    for (var i = 0; i < data.length; ++i) {
        if (years.length === 0 || years[years.length - 1] !== data[i][4]) {
            years.push(data[i][4]);
        }
    }

    function getFlag(countryName) {
        if (!countryName) {
            return '';
        }
        return (flags.find(function (item) {
            return item.name === countryName;
        }) || {}).emoji;
    }
    var startIndex = 10;
    var startYear = years[startIndex];

    var option = {
        grid: {
            top: 10,
            bottom: 30,
            left: 150,
            right: 80
        },
        xAxis: {
            max: 'dataMax',
            label: {
                formatter: function (n) {
                    return Math.round(n);
                }
            }
        },
        dataset: {
            source: data.slice(1).filter(function (d) {
                return d[4] === startYear;
            })
        },
        yAxis: {
            type: 'category',
            inverse: true,
            max: 10,
            axisLabel: {
                show: true,
                textStyle: {
                    fontSize: 14
                },
                formatter: function (value) {
                    return value + '{flag|' + getFlag(value) + '}';
                },
                rich: {
                    flag: {
                        fontSize: 25,
                        padding: 5
                    }
                }
            },
            animationDuration: 300,
            animationDurationUpdate: 300
        },
        series: [{
            realtimeSort: true,
            seriesLayoutBy: 'column',
            type: 'bar',
            itemStyle: {
                color: function (param) {
                    return countryColors[param.value[3]] || '#5470c6';
                }
            },
            encode: {
                x: dimension,
                y: 3
            },
            label: {
                show: true,
                precision: 1,
                position: 'right',
                valueAnimation: true,
                fontFamily: 'monospace'
            }
        }],
        // Disable init animation.
        animationDuration: 0,
        animationDurationUpdate: updateFrequency,
        animationEasing: 'linear',
        animationEasingUpdate: 'linear',
        graphic: {
            elements: [{
                type: 'text',
                right: 160,
                bottom: 60,
                style: {
                    text: startYear,
                    font: 'bolder 80px monospace',
                    fill: 'rgba(100, 100, 100, 0.25)'
                },
                z: 100
            }]
        }
    };

    // console.log(option);
    myChart.setOption(option);

    for (var i = startIndex; i < years.length - 1; ++i) {
        (function (i) {
            setTimeout(function () {
                updateYear(years[i + 1]);
            }, (i - startIndex) * updateFrequency);
        })(i);
		console.log("动态图表测试！")
    }

    function updateYear(year) {
        var source = data.slice(1).filter(function (d) {
            return d[4] === year;
        });
        option.series[0].data = source;
        option.graphic.elements[0].style.text = year;
        myChart.setOption(option);
    }
	
	
	
	} /* alerts "123" */
    );
	showTrafficRank();
 
});
function loadMap(){
    map = new BMapGL.Map("map");
    map.centerAndZoom(new BMapGL.Point(116.351376,40.002346), 14);
	map.enableScrollWheelZoom(true); // 开启鼠标滚轮缩放
	map.setDisplayOptions({
    poiText: false,  // 隐藏poi标注
    //poiIcon: false,  // 隐藏poi图标
    //building: false  // 隐藏楼块
});
  map.setMapStyleV2({     
  styleId: 'f93e20266be1e44e35abd488256458fe'
});
map.setTrafficOn(); // 叠加路况图层
		
}

// 自定义canvas
function getTextureCanvas() {
    var textureCanvas = document.createElement('canvas');
    textureCanvas.width = textureCanvas.height = 200;
    var ctx = textureCanvas.getContext('2d');
    ctx.fillStyle = '#79a913';
    ctx.strokeStyle = '#79a913';
	ctx.fillOpacity=0.9;
    ctx.lineWidth = 6;
    ctx.lineCap = 'square';
    ctx.fillRect(0, 0, 200, 200);
    ctx.moveTo(50, 50);
    ctx.lineTo(150, 50);
    ctx.lineTo(150, 150);
    ctx.lineTo(50, 150);
    ctx.lineTo(50, 50);
    ctx.stroke();
    return textureCanvas;
}
//添加场馆
function addVenue(){
	
var pStart = new BMapGL.Point(116.381452,40.018565);
var pEnd = new BMapGL.Point(116.410198,40.039006);
var bounds = new BMapGL.Bounds(new BMapGL.Point(pStart.lng, pEnd.lat), new BMapGL.Point(pEnd.lng, pStart.lat));
var canvasOverlay = new BMapGL.GroundOverlay(bounds, {
    type: 'canvas',
    url: getTextureCanvas(),
    opacity: 0.9
});
map.addOverlay(canvasOverlay);

// 添加文本标注
var opts = {
    position: new BMapGL.Point(116.3980000,40.025084),
    offset: new BMapGL.Size(-93, -55)
};
var label = new BMapGL.Label('奥林匹克森林公园', opts);
label.setStyle({
    color: '#fff',
    borderRadius: '5px',
    borderColor: '#fff',
    backgroundColor: '#79a913',
    fontSize: '20px',
    height: '40px',
    lineHeight: '35px',
	maxWidth:"none",
	
});
//label.setZIndex(zIndex:1);
map.addOverlay(label);

}

function loadPoly(){
	// 根据出入流量显示不同颜色
//>5000红色；>1000黄色；>500蓝色；>100粉色；其余是绿色
var region_o1=[];
var region_o2=[];
var region_o3=[];
var region_o4=[];
var region_o5=[];
var trafficIndexSum=0.0;
var regionWithTrafficIndex=bregion_model;

var polyColor=[];
//计算交通指数总和
for(var i=0;i<bregion_model.length;i++){
	trafficIndexSum=trafficIndexSum+Math.abs(bregion_model[i]["NetFlow"]);
}
//计算每个区域的交通指数
for(var i=0;i<bregion_model.length;i++){
	var temp;
	temp=5*(Math.abs(bregion_model[i]["NetFlow"]))/(trafficIndexSum*1.0);
	trafficIndex.push(temp.toFixed(2));
}
//为每个多边形添加交通指数属性
for(var i=0;i<bregion_model.length;i++){
	regionWithTrafficIndex[i]['trafficIndex']=trafficIndex[i];
	if(trafficIndex[i]>=0.5){
		polyColor.push('#FF0000');
	}
	else if(trafficIndex[i]>=0.1){
		polyColor.push('#FFA500');
	}
	else {
		polyColor.push('#00FF7F');
	}
}
//console.log(trafficIndex);
//console.log(polyColor);

//绘制多边形区域
var polygon;
for(var i=0;i<regionWithTrafficIndex.length;i++){
var lines=[];
//根据交通指数分别绘制多边形
for(var j=0;j<regionWithTrafficIndex[i]["poly"].length;j++){
lines.push(new BMapGL.Point(regionWithTrafficIndex[i]["poly"][j][0], regionWithTrafficIndex[i]["poly"][j][1]));
}
polygon = new BMapGL.Polygon(lines, {
    strokeColor: '#FFFFFF',
    strokeWeight: 2,
    strokeOpacity: 0.5,
	fillColor: polyColor[i]
});
map.addOverlay(polygon);

}
}
//获取多边形的中心点
function getCenterPoint(path) {
  //var path =e.;//Array<Point> 返回多边型的点数组
  //var ret=parseFloat(num1)+parseFloat(num2);
  //console.log(path);
  var x = 0.0;
  var y = 0.0;
  for (var i = 0; i < path.length; i++) {
    x = x + parseFloat(path[i][0]);
    y = y + parseFloat(path[i][1]);
  }
  x = x / path.length;
  y = y / path.length;

  //return new BMap.Point(path[0].lng,path[0].lat);
  return new BMapGL.Point(x, y);
  //return path[0];
}

//添加每个区域的交通指数
function addTrafficIndex(){
	for(var i=0;i<bregion_model.length;i++){

		var point=getCenterPoint(bregion_model[i]["poly"]);
		
		var opts = {    
        position : point,    // 指定文本标注所在的地理位置    
        offset   : new BMapGL.Size(0, 0)    //设置文本偏移量    
       }    
     var label = new BMapGL.Label(trafficIndex[i], opts);  // 创建文本标注对象    
        label.setStyle({    
        color : "BLUE", 
		fontSize : "16px",
		height : "20px",
		lineHeight : "20px",
		fontFamily:"微软雅黑",　
		maxWidth:"none",
		backgroundColor: "0.000000000001", 
		border:"0"		
        });    
      map.addOverlay(label);  	
		
	}

   
}
//添加区域重要公交地铁站点
function addMarker(){
	//重要公交站点
	var stations=[
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥东","Lng":116.38552,"Lat":40.00913615,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B二里庄北口","Lng":116.3752704,"Lat":40.00878817,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B南沙滩","Lng":116.3865837,"Lat":40.00363204,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B双泉堡","Lng":116.3775527,"Lat":40.01555985,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北京科技大学北门","Lng":116.3718818,"Lat":40.00088441,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥西","Lng":116.3796061,"Lat":40.00882345,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新路","Lng":116.3800677,"Lat":40.00137604,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新路东口","Lng":116.3854707,"Lat":40.00164418,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B二里庄","Lng":116.3775653,"Lat":40.0067989,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B二里庄南口","Lng":116.3777683,"Lat":40.00233387,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新北里","Lng":116.381759,"Lat":40.00074348,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B中国农业大学东校区","Lng":116.3696507,"Lat":40.00850902,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B科荟路西口","Lng":116.3699537,"Lat":40.01520523,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R北沙滩","Lng":116.3748462,"Lat":40.00749515,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B志新桥北","Lng":116.3820132,"Lat":39.99584476,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥南","Lng":116.383371,"Lat":40.00781286,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩桥北","Lng":116.3814279,"Lat":40.01037694,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B双泉堡南","Lng":116.3793873,"Lat":40.01308101,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R北京科技大学北门","Lng":116.3718818,"Lat":40.00088441,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B北沙滩","Lng":116.3748462,"Lat":40.00749515,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R北沙滩桥东","Lng":116.38552,"Lat":40.00913615,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R二里庄南口","Lng":116.3777683,"Lat":40.00233387,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"R志新路","Lng":116.3800677,"Lat":40.00137604,"":"aosen"},
{"AreaID":"wx4g85jkq7ex","Station":"B双泉堡东","Lng":116.3788059,"Lat":40.01714662,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R奥林匹克公园","Lng":116.3992082,"Lat":40.00727944,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B奥运村西","Lng":116.388364,"Lat":40.01248452,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B中科院地理所","Lng":116.3959637,"Lat":40.00950142,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B南沟泥河","Lng":116.3915035,"Lat":40.0095468,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B国家体育馆","Lng":116.3998868,"Lat":40.00342605,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B科学园南里","Lng":116.3939891,"Lat":40.0054449,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B科学园南里中街","Lng":116.3931255,"Lat":40.00693123,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔桥北","Lng":116.3881932,"Lat":40.00240182,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔桥南","Lng":116.3887805,"Lat":40.00080926,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔北路西口","Lng":116.393671,"Lat":40.00198966,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B新闻中心","Lng":116.3994991,"Lat":40.0085419,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R南沟泥河","Lng":116.3915035,"Lat":40.0095468,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R安翔北路西口","Lng":116.393671,"Lat":40.00198966,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B奥林匹克公园","Lng":116.3992082,"Lat":40.00727944,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R奥运村西","Lng":116.388364,"Lat":40.01248452,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R国家体育馆","Lng":116.3998868,"Lat":40.00342605,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"B安翔北路东口","Lng":116.3988158,"Lat":40.00222076,"":"aosen"},
{"AreaID":"wx4g8eqd9f3v","Station":"R中科院地理所","Lng":116.3959637,"Lat":40.00950142,"":"aosen"},
{"AreaID":"wx4ex3x2kwc7","Station":"R五道口","Lng":116.34444771316686,"Lat":39.99844346071147,"":"aosen"},
];
console.log(stations);
	// 创建点标记
	for(var i=0;i<stations.length;i++){
		var marker = new BMapGL.Marker(new BMapGL.Point(stations[i]['Lng'], stations[i]['Lat']));	
        map.addOverlay(marker);
	}
}

////行车路线规划实例
function RoadStatus(p1,p2,color){
	//console.log(color);
 var transit = new BMapGL.TransitRoute(map,{
            renderOptions: {map: map, autoViewport: false},onMarkersSet:function(routes) {
		  //当地图标记添加完成时调用
				for (var i = 0; i <routes.length; i++) {
						//判断是否是途经点
						if(typeof(routes[i].Km)=="undefined"){
								map.removeOverlay(routes[i].marker); //删除起始默认图标
						}else{
								map.removeOverlay(routes[i].Km); //删除途经默认图标
						}
				}
			}
        });
	    transit.search(p1, p2);
		}
//添加重点站点（奥林匹克公园站R和国家体育馆B）的路线	
function mainRunningTrack(){
	//奥林匹克公园站R	116.3992082,40.00727944
	//国家体育馆B	116.3998868,40.00342605
	//北京西R 		116.327811,39.900677
	//北京西B		116.328103,39.900835
	//首都机场		116.609564,40.083812
	//(116.39596370968889,40.009501418660314)//B中科院地理所,
	//(116.38551997526146,40.00913615115001)//R北沙滩桥东
	//116.424499,40.006865 汉庭优佳酒店(亚运村鸟巢新店)
	//116.378388,40.040981 丽枫酒店(鸟巢店)
	//116.414285,40.008946安立路地铁站
	var p1=new BMapGL.Point(116.3992082,40.00727944);//奥林匹克公园站R
	var p2=new BMapGL.Point(116.327811,39.900677);//北京西R
	var p3=new BMapGL.Point(116.3992082,40.00727944);//奥林匹克公园站R
	var p4=new BMapGL.Point(116.609564,40.083812);//首都机场
	var p5=new BMapGL.Point(116.38551997526146,40.00913615115001)//R北沙滩桥东
	var p6=new BMapGL.Point(116.327811,39.900677);//北京西R
	var p7=new BMapGL.Point(116.3992082,40.00727944);//奥林匹克公园站R
	var p8=new BMapGL.Point(116.424499,40.006865);// 汉庭优佳酒店(亚运村鸟巢新店)
	var p9=new BMapGL.Point(116.38551997526146,40.00913615115001);//R北沙滩桥东
	var p10=new BMapGL.Point(116.378388,40.040981); //丽枫酒店(鸟巢店)
	var p11=new BMapGL.Point(116.414285,40.008946); //安立路R
	var color='#00BFFF';
	var color1='#00BFFF';
	RoadStatus(p1,p2,color);
	RoadStatus(p3,p4,color);
	RoadStatus(p5,p6,color);
	RoadStatus(p5,p6,color);
	RoadStatus(p3,p11,color1);
	RoadStatus(p9,p10,color1);
	
	
}

function addStations(stations){
	//console.log(stations);
	//处理数据
	var flowdata=[];
	
	for(var i=0;i<stations.length;i++){
	var temp=[];
		temp.push(stations[i]['AreaID']);
		temp.push(stations[i]['Station']);
		temp.push(parseFloat(stations[i]['Lng']));
		temp.push(parseFloat(stations[i]['Lat']));
		flowdata.push(temp);
}


console.log(flowdata);
//添加公交站点信息窗口和公交站点标识
	for(var p=0;p<flowdata.length;p++){
		
	var opts = {
    position: new BMapGL.Point(flowdata[p][2], flowdata[p][3]), // 指定文本标注所在的地理位置
    offset: new BMapGL.Size(10, -30) // 设置文本偏移量
};
// 创建文本标注对象
var str;
if(flowdata[p][1].substr(0,1)=='B'){
	str=flowdata[p][1].substr(1,flowdata[p][1].length-1)+"公交站"
}
if(flowdata[p][1].substr(0,1)=='R')
{
	str=flowdata[p][1].substr(1,flowdata[p][1].length-1)+"地铁站"
}
var marker = new BMapGL.Marker(new BMapGL.Point(flowdata[p][2], flowdata[p][3]));
map.addOverlay(marker);
var label = new BMapGL.Label(str, opts);  // 创建文本标注对象
        label.setStyle({
             color : "black",
             fontSize : "10px",
             height : "15px",
             lineHeight : "12px",
             fontFamily:"微软雅黑",
			 backgroundColor :"white", //文本标注背景颜色　
			 maxWidth:"none",
			 border:"0"
         });
    map.addOverlay(label);  
	}
	
}
//客流量动态排序
function showTrafficRank(){
    myChart = echarts.init(document.getElementById('trafficRank'));
	var updateFrequency = 8000;
	var dimension = 0;

	//var countryColors = {"Australia":"#00008b","Canada":"#f00","China":"#ffde00","Cuba":"#002a8f","Finland":"#003580","France":"#ed2939","Germany":"#000","Iceland":"#003897","India":"#f93","Japan":"#bc002d","North Korea":"#024fa2","South Korea":"#000","New Zealand":"#00247d","Norway":"#ef2b2d","Poland":"#dc143c","Russia":"#d52b1e","Turkey":"#e30a17","United Kingdom":"#00247d","United States":"#b22234"};


    //var flags = res0[0];
    //var data = res1[0];
	var flags=[{code: "AD", emoji: "🇦🇩", unicode: "U+1F1E6 U+1F1E9", name: "Andorra", title: "flag for Andorra"},
	{code: "AE", emoji: "🇦🇪", unicode: "U+1F1E6 U+1F1EA", name: "United Arab Emirates", title: "flag for United Arab Emirates"},
	{code: "AF", emoji: "🇦🇫", unicode: "U+1F1E6 U+1F1EB", name: "Afghanistan", title: "flag for Afghanistan"}];
	
	var data=[["Income", "Life Expectancy", "Population", "Country", "Year"],
	[815, 34.05, 351014, "Australia", 1800],[1314, 39, 645526, "Canada", 1800],
	[985, 32, 321675013, "China", 1800],[864, 32.2, 345043, "Cuba", 1800]];
	
    var years = [];
    for (var i = 0; i < data.length; ++i) {
        if (years.length === 0 || years[years.length - 1] !== data[i][4]) {
            years.push(data[i][4]);
        }
    }

    function getFlag(countryName) {
        if (!countryName) {
            return '';
        }
        return (flags.find(function (item) {
            return item.name === countryName;
        }) || {}).emoji;
    }
    var startIndex = 10;
    var startYear = years[startIndex];

    var option = {
        grid: {
            top: 10,
            bottom: 30,
            left: 150,
            right: 80
        },
        xAxis: {
            max: 'dataMax',
            label: {
                formatter: function (n) {
                    return Math.round(n);
                }
            }
        },
        dataset: {
            source: data.slice(1).filter(function (d) {
                return d[4] === startYear;
            })
        },
        yAxis: {
            type: 'category',
            inverse: true,
            max: 10,
            axisLabel: {
                show: true,
                textStyle: {
                    fontSize: 14
                },
                formatter: function (value) {
                    return value + '{flag|' + getFlag(value) + '}';
                },
                rich: {
                    flag: {
                        fontSize: 25,
                        padding: 5
                    }
                }
            },
            animationDuration: 300,
            animationDurationUpdate: 300
        },
        series: [{
            realtimeSort: true,
            seriesLayoutBy: 'column',
            type: 'bar',
            itemStyle: {
                color: function (param) {
                    return countryColors[param.value[3]] || '#5470c6';
                }
            },
            encode: {
                x: dimension,
                y: 3
            },
            label: {
                show: true,
                precision: 1,
                position: 'right',
                valueAnimation: true,
                fontFamily: 'monospace'
            }
        }],
        // Disable init animation.
        animationDuration: 0,
        animationDurationUpdate: updateFrequency,
        animationEasing: 'linear',
        animationEasingUpdate: 'linear',
        graphic: {
            elements: [{
                type: 'text',
                right: 160,
                bottom: 60,
                style: {
                    text: startYear,
                    font: 'bolder 80px monospace',
                    fill: 'rgba(100, 100, 100, 0.25)'
                },
                z: 100
            }]
        }
    };

    // console.log(option);
    myChart.setOption(option);

    for (var i = startIndex; i < years.length - 1; ++i) {
        (function (i) {
            setTimeout(function () {
                updateYear(years[i + 1]);
            }, (i - startIndex) * updateFrequency);
        })(i);
		console.log("动态图表测试！")
    }

    function updateYear(year) {
        var source = data.slice(1).filter(function (d) {
            return d[4] === year;
        });
        option.series[0].data = source;
        option.graphic.elements[0].style.text = year;
        myChart.setOption(option);
    }

		

}










		


